{% extends "base.html" %}

{% block title %}{{ tax_return.property_address }} - Review{% endblock %}

{% block content %}
{# Calculate counts for dashboard #}
{% set provided_count = document_inventory.provided|length if document_inventory else 0 %}
{% set missing_count = document_inventory.missing|length if document_inventory else 0 %}
{% set flagged_count = review.flagged_transactions_summary.total_flagged if review.flagged_transactions_summary else 0 %}
{% set blocking_count = review.blocking_issues|length if review.blocking_issues else 0 %}

<div class="w-full space-y-6" x-data="transactionProcessor()">

    <!-- Progress Stepper -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex items-center justify-between max-w-3xl mx-auto">
            <!-- Step 1: Upload -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <span class="ml-2 text-sm font-medium text-primary">Upload</span>
            </div>
            <div class="flex-1 h-1 mx-4 bg-green-500"></div>

            <!-- Step 2: Classification -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <span class="ml-2 text-sm font-medium text-primary">Classified</span>
            </div>
            <div class="flex-1 h-1 mx-4 {% if tax_return.status.value == 'complete' %}bg-green-500{% else %}bg-slate{% endif %}"></div>

            <!-- Step 3: Review -->
            <div class="flex items-center">
                {% if tax_return.status.value == 'complete' %}
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                {% elif tax_return.status.value == 'blocked' %}
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-red-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                {% else %}
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-accent text-white animate-pulse">
                    <span class="text-sm font-bold">3</span>
                </div>
                {% endif %}
                <span class="ml-2 text-sm font-medium {% if tax_return.status.value == 'blocked' %}text-red-600{% elif tax_return.status.value == 'complete' %}text-primary{% else %}text-accent{% endif %}">Review</span>
            </div>
            <div class="flex-1 h-1 mx-4 bg-slate"></div>

            <!-- Step 4: Workings -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-slate text-gray-500">
                    <span class="text-sm font-bold">4</span>
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Workings</span>
            </div>
        </div>
    </div>

    <!-- Summary Stats Row -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <!-- Status -->
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-500">Status:</span>
                <span class="px-3 py-1 rounded-full text-sm font-medium
                    {% if tax_return.status.value == 'complete' %}bg-green-100 text-green-800
                    {% elif tax_return.status.value == 'blocked' %}bg-red-100 text-red-800
                    {% elif tax_return.status.value == 'incomplete' %}bg-yellow-100 text-yellow-800
                    {% else %}bg-slate-light text-primary{% endif %}">
                    {{ tax_return.status.value|upper }}
                </span>
            </div>

            <!-- Documents -->
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-slate" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="text-sm text-primary"><strong>{{ provided_count }}</strong> documents</span>
                {% if missing_count > 0 %}
                <span class="text-sm text-accent">({{ missing_count }} missing)</span>
                {% endif %}
            </div>

            <!-- Issues -->
            <div class="flex items-center gap-2">
                {% if blocking_count > 0 %}
                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span class="text-sm text-red-600"><strong>{{ blocking_count }}</strong> blocking</span>
                {% elif flagged_count > 0 %}
                <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span class="text-sm text-yellow-600"><strong>{{ flagged_count }}</strong> to review</span>
                {% else %}
                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-green-600">No issues</span>
                {% endif %}
            </div>

            <!-- Tax Year -->
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-slate" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm text-primary"><strong>{{ tax_return.tax_year }}</strong> (Year {{ tax_return.year_of_ownership }})</span>
            </div>

            <!-- Proceed to Workings -->
            {% if tax_return.status.value != 'blocked' %}
            <a href="/workings/{{ tax_return.id }}"
               class="inline-flex items-center px-4 py-2 bg-accent hover:bg-accent-600 text-white rounded-lg font-medium text-sm shadow-sm transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
                {% if tax_return.status.value == 'complete' %}Generate Workings{% else %}View Workings{% endif %}
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Next Steps Card -->
    <div class="bg-gradient-to-r {% if tax_return.status.value == 'blocked' %}from-red-50 to-red-100 border-red-200{% elif tax_return.status.value == 'incomplete' %}from-yellow-50 to-amber-50 border-yellow-200{% elif tax_return.status.value == 'complete' %}from-green-50 to-emerald-50 border-green-200{% else %}from-slate-light to-slate border-slate{% endif %} border rounded-lg p-6">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                {% if tax_return.status.value == 'blocked' %}
                <div class="p-3 bg-red-200 rounded-full">
                    <svg class="w-6 h-6 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                {% elif tax_return.status.value == 'incomplete' %}
                <div class="p-3 bg-yellow-200 rounded-full">
                    <svg class="w-6 h-6 text-yellow-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                {% elif tax_return.status.value == 'complete' %}
                <div class="p-3 bg-green-200 rounded-full">
                    <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                {% else %}
                <div class="p-3 bg-white rounded-full">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                {% endif %}
            </div>
            <div class="flex-grow">
                <h3 class="text-lg font-semibold {% if tax_return.status.value == 'blocked' %}text-red-900{% elif tax_return.status.value == 'incomplete' %}text-yellow-900{% elif tax_return.status.value == 'complete' %}text-green-900{% else %}text-primary{% endif %}">
                    {% if tax_return.status.value == 'blocked' %}
                    Action Required: Resolve Blocking Issues
                    {% elif tax_return.status.value == 'incomplete' %}
                    Next Step: Add Missing Documents
                    {% elif tax_return.status.value == 'complete' %}
                    Ready to Generate Workings!
                    {% else %}
                    Processing In Progress
                    {% endif %}
                </h3>
                <p class="mt-1 text-sm {% if tax_return.status.value == 'blocked' %}text-red-700{% elif tax_return.status.value == 'incomplete' %}text-yellow-800{% elif tax_return.status.value == 'complete' %}text-green-700{% else %}text-primary-700{% endif %}">
                    {% if tax_return.status.value == 'blocked' %}
                    There are {{ blocking_count }} blocking issue{{ 's' if blocking_count > 1 else '' }} that must be resolved before proceeding. Review the issues below and either provide the correct documents or confirm the issue is not applicable.
                    {% elif tax_return.status.value == 'incomplete' %}
                    <span class="block">Missing documents:</span>
                    <ul class="mt-2 space-y-1">
                        {% for doc in document_inventory.missing %}
                        <li class="flex items-center gap-2">
                            {% if doc.severity == 'required' %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">Required</span>
                            {% else %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">Recommended</span>
                            {% endif %}
                            <span>{{ doc.reason }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    <span class="block mt-2 text-yellow-700">Add the missing documents or proceed with available data.</span>
                    {% elif tax_return.status.value == 'complete' %}
                    All required documents are provided and classified. Click "Generate Workings" to create the P&L breakdown with full audit trail.
                    {% else %}
                    Documents are being processed. Please wait for classification to complete.
                    {% endif %}
                </p>
            </div>
            <div class="flex-shrink-0">
                {% if tax_return.status.value in ['incomplete', 'blocked'] %}
                <button onclick="toggleAddDocuments()"
                        class="inline-flex items-center px-4 py-2.5 bg-white border-2 border-yellow-300 text-yellow-800 rounded-lg hover:bg-yellow-50 font-medium text-sm transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Documents
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Documents Section (Hidden by default) -->
    <div id="addDocumentsSection" class="bg-white shadow rounded-lg p-6 hidden">
        <h3 class="text-lg font-medium text-primary mb-4">Add Additional Documents</h3>

        <form id="addDocumentsForm" action="/result/{{ tax_return.id }}/add-documents" method="POST" enctype="multipart/form-data">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                 id="addDocsDropzone"
                 ondragover="event.preventDefault(); this.classList.add('border-accent', 'bg-rose-light');"
                 ondragleave="this.classList.remove('border-accent', 'bg-rose-light');"
                 ondrop="event.preventDefault(); this.classList.remove('border-accent', 'bg-rose-light'); handleAddDocsDrop(event);">

                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>

                <div class="mt-4">
                    <label for="additionalFiles" class="cursor-pointer">
                        <span class="text-sm font-medium text-primary">Drop files here or click to browse</span>
                        <input id="additionalFiles" name="files" type="file" multiple required
                               accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv"
                               class="sr-only" onchange="handleAddDocsFiles(this.files)">
                    </label>
                </div>

                <p class="mt-2 text-xs text-gray-500">PDF, PNG, JPG, JPEG, XLSX, XLS, CSV up to 50MB each</p>
            </div>

            <!-- Selected Files Preview -->
            <div id="addDocsFileList" class="mt-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Files (<span id="addDocsFileCount">0</span>)</h4>
                <ul id="addDocsFileListItems" class="divide-y divide-gray-200 border border-gray-200 rounded-md"></ul>
            </div>

            <div class="mt-4 flex justify-end space-x-3">
                <button type="button" onclick="toggleAddDocuments()"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">
                    Cancel
                </button>
                <button type="submit" id="addDocsSubmitBtn"
                        class="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent-700 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="addDocsSubmitText">Upload & Analyze</span>
                    <span id="addDocsSubmitLoading" class="hidden flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Property Details - Compact Header -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
            <!-- Property Address & Client -->
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <div>
                    <span class="font-semibold text-gray-900">{{ tax_return.property_address }}</span>
                    <span class="text-gray-400 mx-2">|</span>
                    <span class="text-gray-600">{{ client.name }}</span>
                </div>
            </div>

            <!-- Property Tags -->
            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <!-- Property Type -->
                {% if tax_return.property_type.value == "new_build" %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    New Build (100% Interest)
                </span>
                {% elif tax_return.property_type.value == "existing" %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-700">
                    Existing (80% Interest)
                </span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-rose-light text-accent">
                    Type: Not Sure
                </span>
                {% endif %}

                <!-- GST Status -->
                {% if tax_return.gst_registered is none %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-rose-light text-accent">
                    GST: Not Sure
                </span>
                {% elif tax_return.gst_registered %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent-100 text-accent">
                    GST Registered
                </span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-light text-primary-700">
                    Not GST Registered
                </span>
                {% endif %}

                <!-- Year of Ownership -->
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-light text-primary">
                    Year {{ tax_return.year_of_ownership }}
                </span>
            </div>
        </div>
    </div>

    <!-- AI Property Type Suggestion (when user selected "Not Sure") -->
    {% if tax_return.property_type.value == "not_sure" and review.property_type_suggestion %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-blue-900 mb-4">AI Property Type Suggestion</h3>

        <div class="space-y-4">
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 mr-2">Suggested Type:</span>
                <span class="px-3 py-1 rounded-full text-sm font-semibold
                    {% if review.property_type_suggestion.suggested_type == 'new_build' %}
                        bg-green-100 text-green-800
                    {% else %}
                        bg-blue-100 text-blue-800
                    {% endif %}">
                    {{ "New Build" if review.property_type_suggestion.suggested_type == "new_build" else "Existing Property" }}
                </span>
                {% if review.property_type_suggestion.confidence %}
                <span class="ml-3 text-sm text-gray-500">
                    ({{ "%.0f"|format(review.property_type_suggestion.confidence * 100) }}% confidence)
                </span>
                {% endif %}
            </div>

            {% if review.property_type_suggestion.reasoning %}
            <div>
                <span class="text-sm font-medium text-gray-700">Reasoning:</span>
                <p class="mt-1 text-sm text-gray-600">{{ review.property_type_suggestion.reasoning }}</p>
            </div>
            {% endif %}

            {% if review.property_type_suggestion.suggested_type == "new_build" %}
            <div class="mt-2 p-3 bg-green-50 rounded-md">
                <p class="text-sm text-green-800">
                    <strong>Tax Benefit:</strong> As a new build, you may be eligible for <strong>100% interest deductibility</strong>
                    (if CCC issued after 27 March 2020).
                </p>
            </div>
            {% else %}
            <div class="mt-2 p-3 bg-yellow-50 rounded-md">
                <p class="text-sm text-yellow-800">
                    <strong>Note:</strong> Existing properties are eligible for <strong>80% interest deductibility</strong>
                    (2024/25 tax year).
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- AI GST Registration Suggestion (when user selected "Not Sure") -->
    {% if tax_return.gst_registered is none and review.gst_suggestion %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-blue-900 mb-4">AI GST Registration Suggestion</h3>

        <div class="space-y-4">
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 mr-2">Suggested Status:</span>
                <span class="px-3 py-1 rounded-full text-sm font-semibold
                    {% if review.gst_suggestion.suggested_status %}
                        bg-green-100 text-green-800
                    {% else %}
                        bg-gray-100 text-gray-800
                    {% endif %}">
                    {{ "GST Registered" if review.gst_suggestion.suggested_status else "Not GST Registered" }}
                </span>
                {% if review.gst_suggestion.confidence %}
                <span class="ml-3 text-sm text-gray-500">
                    ({{ "%.0f"|format(review.gst_suggestion.confidence * 100) }}% confidence)
                </span>
                {% endif %}
            </div>

            {% if review.gst_suggestion.reasoning %}
            <div>
                <span class="text-sm font-medium text-gray-700">Reasoning:</span>
                <p class="mt-1 text-sm text-gray-600">{{ review.gst_suggestion.reasoning }}</p>
            </div>
            {% endif %}

            {% if review.gst_suggestion.evidence %}
            <div>
                <span class="text-sm font-medium text-gray-700">Evidence:</span>
                <ul class="mt-1 text-sm text-gray-600 list-disc list-inside">
                    {% for item in review.gst_suggestion.evidence %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if review.gst_suggestion.suggested_status %}
            <div class="mt-2 p-3 bg-green-50 rounded-md">
                <p class="text-sm text-green-800">
                    <strong>Note:</strong> If GST registered, you can claim GST on expenses and must charge GST on rent. More complex accounting requirements apply.
                </p>
            </div>
            {% else %}
            <div class="mt-2 p-3 bg-gray-50 rounded-md">
                <p class="text-sm text-gray-700">
                    <strong>Note:</strong> Most small residential rental properties are not GST registered. Simpler accounting, no GST claims or charges.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Blocking Issues (if any) -->
    {% set resolved_issues = review.resolved_blocking_issues or [] %}
    {% set unresolved_issues = review.blocking_issues | reject('in', resolved_issues) | list if review.blocking_issues else [] %}
    {% if review.blocking_issues %}
    <div class="bg-red-50 border border-red-200 rounded-lg p-6" id="blockingIssuesSection">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-red-900">Blocking Issues</h3>
            <div class="flex items-center gap-2">
                <span class="text-sm text-red-700">{{ unresolved_issues | length }} unresolved</span>
                {% if resolved_issues | length > 0 %}
                <span class="text-sm text-green-700">{{ resolved_issues | length }} resolved</span>
                {% endif %}
            </div>
        </div>
        <ul class="space-y-3">
            {% for issue in review.blocking_issues %}
            {% set is_resolved = issue in resolved_issues %}
            <li class="flex items-start justify-between p-3 rounded-lg transition-all duration-300 {{ 'bg-green-50 border border-green-200' if is_resolved else 'bg-white border border-red-100' }}"
                id="blocking-issue-{{ loop.index }}"
                data-issue="{{ issue | e }}">
                <div class="flex items-start flex-grow">
                    {% if is_resolved %}
                    <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium text-green-800 line-through">{{ issue }}</span>
                    {% else %}
                    <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span class="font-medium text-red-900">{{ issue }}</span>
                    {% endif %}
                </div>
                {% if not is_resolved %}
                <div class="flex items-center gap-2 ml-4 flex-shrink-0">
                    <button onclick="handleBlockingIssueOk(this)"
                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition-colors">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        OK
                    </button>
                    <button onclick="handleBlockingIssueFeedback(this)"
                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-primary-700 bg-slate-light hover:bg-slate transition-colors">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                        Feedback
                    </button>
                </div>
                {% else %}
                <span class="text-xs text-green-600 ml-4">Resolved</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Blocking Issue Feedback Modal -->
    <div id="blockingIssueFeedbackModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-primary">Provide Feedback</h3>
                <button onclick="closeBlockingIssueFeedbackModal()" class="text-slate hover:text-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="blockingIssueFeedbackForm" onsubmit="submitBlockingIssueFeedback(event)">
                <input type="hidden" id="blockingIssueText" name="issue_text">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-primary-700 mb-1">Blocking Issue</label>
                    <p id="blockingIssueDisplay" class="text-sm text-primary-700 bg-cream p-2 rounded"></p>
                </div>
                <div class="mb-4">
                    <label for="blockingIssueFeedbackContent" class="block text-sm font-medium text-primary-700 mb-1">
                        Why shouldn't this be a blocking issue?
                    </label>
                    <textarea id="blockingIssueFeedbackContent" name="feedback_content" rows="4"
                              class="w-full border border-slate rounded-md shadow-sm focus:ring-accent focus:border-accent"
                              placeholder="Explain why this is a false positive and shouldn't block the tax return..."
                              required></textarea>
                    <p class="mt-1 text-xs text-slate">This feedback will be stored to prevent similar false positives in the future.</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeBlockingIssueFeedbackModal()"
                            class="px-4 py-2 text-sm font-medium text-primary-700 bg-slate-light rounded-md hover:bg-slate">
                        Cancel
                    </button>
                    <button type="submit" id="blockingIssueFeedbackSubmit"
                            class="px-4 py-2 text-sm font-medium text-white bg-accent rounded-md hover:bg-accent-600">
                        Submit Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Duplicate Files Warning -->
    {% set duplicate_docs = documents | selectattr('is_duplicate') | list %}
    {% if duplicate_docs | length > 0 %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-yellow-900 mb-4">Duplicate Files Detected ({{ duplicate_docs | length }})</h3>
        <p class="text-sm text-yellow-700 mb-3">
            The following files were identified as duplicates and were not re-analyzed to save processing time.
            Classification was copied from the original document.
        </p>
        <ul class="space-y-2">
            {% for doc in duplicate_docs %}
            <li class="flex items-start">
                <span class="text-yellow-600 mr-2">•</span>
                <span class="text-yellow-800">
                    <strong>{{ doc.original_filename }}</strong>
                    {% if doc.extracted_data and doc.extracted_data.duplicate_info %}
                    → duplicate of "{{ doc.extracted_data.duplicate_info.original_filename }}"
                    ({{ doc.extracted_data.duplicate_info.type }})
                    {% endif %}
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Flagged Transactions Section -->
    {% if review.flagged_transactions_summary and review.flagged_transactions_summary.total_flagged > 0 %}
    <div class="bg-white border border-orange-200 rounded-lg shadow-sm overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 px-6 py-4 border-b border-orange-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            Transactions to Review
                        </h3>
                        <p class="text-sm text-gray-600">{{ review.flagged_transactions_summary.total_flagged }} transaction{{ 's' if review.flagged_transactions_summary.total_flagged > 1 else '' }} requiring attention</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    {% if review.flagged_transactions_summary.critical_count > 0 %}
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ review.flagged_transactions_summary.critical_count }} Critical
                    </span>
                    {% endif %}
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        <span id="reconciledCount">0</span>/{{ review.flagged_transactions_summary.total_flagged }} Reconciled
                    </span>
                </div>
            </div>
        </div>

        <!-- Transaction Cards -->
        <div class="divide-y divide-gray-100">
            {% for txn in review.flagged_transactions_summary.transactions_requiring_invoices %}
            <div class="p-4 hover:bg-gray-50 transition-colors transaction-row" data-txn-key="{{ txn.document }}:{{ txn.transaction }}:{{ txn.amount }}">
                <div class="flex items-start gap-4">
                    <!-- Amount Badge -->
                    <div class="flex-shrink-0 w-24 text-center">
                        <div class="text-lg font-bold text-gray-900">{{ txn.amount | currency }}</div>
                        <div class="text-xs text-gray-500 mt-0.5">{{ txn.document[:20] }}{% if txn.document|length > 20 %}...{% endif %}</div>
                    </div>

                    <!-- Transaction Details -->
                    <div class="flex-grow min-w-0">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0 flex-grow">
                                <p class="text-sm font-medium text-gray-900 truncate" title="{{ txn.transaction }}">
                                    {{ txn.transaction }}
                                </p>
                                <div class="mt-1 flex items-center gap-2 flex-wrap">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                        {% if 'cash' in txn.reason %}bg-red-100 text-red-700
                                        {% elif 'unusual_vendor' in txn.reason %}bg-red-100 text-red-700
                                        {% elif 'large_payment' in txn.reason %}bg-amber-100 text-amber-700
                                        {% elif 'unclear' in txn.reason %}bg-purple-100 text-purple-700
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        {% if 'cash' in txn.reason %}
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        {% elif 'large_payment' in txn.reason %}
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        {% else %}
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        {% endif %}
                                        {{ txn.reason|replace('_', ' ')|title }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ txn.action_required }}</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex-shrink-0 flex items-center gap-2 action-buttons">
                                <button onclick="quickReconcile(this)"
                                        data-transaction="{{ txn.transaction | e }}"
                                        data-amount="{{ txn.amount }}"
                                        data-document="{{ txn.document | e }}"
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors"
                                        title="Mark as reviewed without saving feedback">
                                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    OK
                                </button>
                                <button onclick="openTransactionFeedback(this)"
                                        data-transaction="{{ txn.transaction | e }}"
                                        data-amount="{{ txn.amount }}"
                                        data-document="{{ txn.document | e }}"
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-white bg-accent hover:bg-accent-700 transition-colors"
                                        title="Categorize and save for AI learning">
                                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    Categorize
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if review.flagged_transactions_summary.recommendation %}
        <!-- Recommendation Footer -->
        <div class="px-6 py-4 bg-amber-50 border-t border-orange-200">
            <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm text-amber-800">
                    <span class="font-medium">Tip:</span> {{ review.flagged_transactions_summary.recommendation }}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions Legend -->
        <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center justify-between text-xs text-gray-500">
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1">
                        <span class="inline-block w-2 h-2 rounded-full bg-gray-300"></span>
                        <strong>OK</strong> = One-off, no AI learning
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="inline-block w-2 h-2 rounded-full bg-accent"></span>
                        <strong>Categorize</strong> = Save for future AI improvement
                    </span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Documents Section -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
        <!-- Header -->
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-primary">Source Documents</h3>
                    <p class="text-sm text-gray-600">{{ documents|length }} document{{ 's' if documents|length > 1 else '' }} uploaded</p>
                </div>
                <div class="text-sm text-gray-500">
                    {% set total_txns = 0 %}
                    {% for doc in documents %}
                        {% if doc.extracted_data and doc.extracted_data.transactions %}
                            {% set total_txns = total_txns + doc.extracted_data.transactions|length %}
                        {% endif %}
                    {% endfor %}
                    {% if total_txns > 0 %}
                    <span class="font-medium text-primary">{{ total_txns }} transactions</span> extracted
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Document List -->
        <div class="divide-y divide-gray-100">
            {% for doc in documents %}
            {% set txn_count = doc.extracted_data.transactions|length if doc.extracted_data and doc.extracted_data.transactions else 0 %}
            <div class="px-6 py-3 flex items-center gap-4 hover:bg-gray-50
                {% if doc.document_type == 'error' %}bg-red-50
                {% elif doc.document_type == 'invalid' or doc.document_type == 'other' %}bg-yellow-50
                {% elif doc.is_duplicate %}bg-gray-100 opacity-60
                {% endif %}">

                <!-- Status Icon -->
                {% if doc.document_type == 'error' %}
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                {% elif doc.document_type == 'invalid' or doc.document_type == 'other' %}
                <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"></path>
                    </svg>
                </div>
                {% elif doc.is_duplicate %}
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2"></path>
                    </svg>
                </div>
                {% else %}
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                {% endif %}

                <!-- Document Info -->
                <div class="flex-grow min-w-0">
                    <p class="text-sm font-medium text-primary truncate">{{ doc.original_filename }}</p>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="text-xs px-2 py-0.5 rounded
                            {% if doc.document_type == 'bank_statement' %}bg-primary-100 text-primary
                            {% elif doc.document_type == 'loan_statement' %}bg-primary-100 text-primary-700
                            {% elif doc.document_type == 'property_manager_statement' %}bg-primary-100 text-primary
                            {% elif doc.document_type == 'settlement_statement' %}bg-rose-light text-accent
                            {% elif doc.document_type == 'landlord_insurance' %}bg-slate-light text-primary
                            {% elif doc.document_type == 'rates' or doc.document_type == 'water_rates' %}bg-cream text-primary-700
                            {% elif doc.document_type == 'body_corporate' %}bg-cream text-primary-700
                            {% elif doc.document_type == 'maintenance_invoice' %}bg-rose-light text-accent-700
                            {% elif doc.document_type == 'error' %}bg-accent-100 text-accent
                            {% elif doc.document_type == 'invalid' %}bg-slate-light text-gray-600
                            {% else %}bg-slate-light text-primary-700{% endif %}">
                            {{ doc.document_type|replace('_', ' ')|title if doc.document_type else 'Unknown' }}
                        </span>
                        {% if doc.is_duplicate %}
                        <span class="text-xs text-slate">Duplicate - skipped</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Transaction Count or Status -->
                <div class="flex-shrink-0 text-right">
                    {% if doc.is_duplicate %}
                    <span class="text-xs text-slate">—</span>
                    {% elif doc.document_type == 'error' %}
                    <span class="text-xs text-accent">Failed</span>
                    {% elif doc.document_type in ['invalid', 'other'] %}
                    <span class="text-xs text-accent-600">Not relevant</span>
                    {% elif txn_count > 0 %}
                    <span class="text-sm font-medium text-primary">{{ txn_count }}</span>
                    <span class="text-xs text-slate block">transactions</span>
                    {% elif doc.document_type in ['landlord_insurance', 'ccc', 'healthy_homes', 'smoke_alarm', 'meth_test', 'lim_report'] %}
                    <span class="text-xs text-green-600">Reference doc</span>
                    {% elif doc.document_type in ['rates', 'water_rates', 'body_corporate', 'resident_society'] %}
                    <span class="text-xs text-slate">Invoice</span>
                    {% else %}
                    <span class="text-xs text-slate">—</span>
                    {% endif %}
                </div>

                <!-- Report Issue (small) -->
                <button onclick="reportDocumentIssue('{{ doc.id }}', '{{ doc.original_filename }}', '{{ doc.document_type }}')"
                        class="flex-shrink-0 p-1.5 text-slate hover:text-accent hover:bg-rose-light rounded transition-colors"
                        title="Report issue with this document">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center">
        <div class="flex gap-2">
            <a href="/" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                ← New Upload
            </a>
            <a href="/feedback?tax_return_id={{ tax_return.id }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Submit Feedback
            </a>
        </div>

        <div class="flex space-x-3">
            <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                Print Report
            </button>
        </div>
    </div>
</div>

<!-- Quick Feedback Modal (Document Classification) -->
<div id="feedbackModal" class="fixed inset-0 bg-primary bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border border-slate w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-primary mb-4" id="modalTitle">Report Classification Issue</h3>

            <form id="quickFeedbackForm" onsubmit="submitQuickFeedback(event)">
                <input type="hidden" id="feedbackDocumentId" name="document_id">
                <input type="hidden" id="feedbackTaxReturnId" name="tax_return_id" value="{{ tax_return.id }}">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document</label>
                    <p id="feedbackFilename" class="text-sm text-gray-900 bg-gray-50 p-2 rounded"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Current Classification
                    </label>
                    <p id="feedbackCurrentType" class="text-sm text-gray-900 bg-gray-50 p-2 rounded"></p>
                </div>

                <div class="mb-4">
                    <label for="correctType" class="block text-sm font-medium text-gray-700 mb-1">
                        Correct Classification <span class="text-red-500">*</span>
                    </label>
                    <select id="correctType" name="correct_type" required
                            class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm">
                        <option value="">Select correct type...</option>
                        <option value="bank_statement">Bank Statement</option>
                        <option value="loan_statement">Loan Statement</option>
                        <option value="settlement_statement">Settlement Statement</option>
                        <option value="depreciation_schedule">Depreciation Schedule</option>
                        <option value="body_corporate">Body Corporate</option>
                        <option value="property_manager_statement">Property Manager Statement</option>
                        <option value="landlord_insurance">Landlord Insurance</option>
                        <option value="ccc">Code Compliance Certificate</option>
                        <option value="rates">Rates Notice</option>
                        <option value="water_rates">Water Rates</option>
                        <option value="healthy_homes">Healthy Homes</option>
                        <option value="meth_test">Meth Test</option>
                        <option value="smoke_alarm">Smoke Alarm Compliance</option>
                        <option value="lim_report">LIM Report</option>
                        <option value="maintenance_invoice">Maintenance Invoice</option>
                        <option value="other">Other (relevant)</option>
                        <option value="invalid">Invalid (not relevant)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="feedbackNotes" class="block text-sm font-medium text-gray-700 mb-1">
                        Additional Notes
                    </label>
                    <textarea id="feedbackNotes" name="notes" rows="3"
                              class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm"
                              placeholder="Why should this be classified differently? Any identifying features?"></textarea>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-accent hover:bg-accent-700">
                        Submit Correction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Feedback Modal -->
<div id="transactionModal" class="fixed inset-0 bg-primary bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border border-slate w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-primary mb-4">Transaction Feedback</h3>

            <form id="transactionFeedbackForm" onsubmit="submitTransactionFeedback(event)">
                <input type="hidden" id="txnFeedbackTaxReturnId" name="tax_return_id" value="{{ tax_return.id }}">

                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-500">Transaction:</span>
                            <p id="txnDescription" class="text-gray-900 truncate"></p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-500">Amount:</span>
                            <p id="txnAmount" class="text-gray-900 font-semibold"></p>
                        </div>
                        <div class="col-span-2">
                            <span class="font-medium text-gray-500">Document:</span>
                            <p id="txnDocument" class="text-gray-900"></p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="txnExpenseCategory" class="block text-sm font-medium text-gray-700 mb-1">
                        Correct Expense Category <span class="text-red-500">*</span>
                    </label>
                    <select id="txnExpenseCategory" name="expense_category" required
                            onchange="toggleCustomCategory(this)"
                            class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm">
                        <option value="">Select expense category...</option>
                        {% for group in category_group_order %}
                        {% if group in categories_by_group %}
                        <optgroup label="{{ group }}">
                            {% for cat in categories_by_group[group] %}
                            <option value="{{ cat.category_code }}">{{ cat.display_name }}{% if not cat.is_deductible and group not in ['Income', 'Excluded'] %} (not deductible){% endif %}</option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        {% endfor %}
                        <optgroup label="─────────────────">
                            <option value="__create_new__">+ Create New Category</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Custom Category Input (hidden by default) -->
                <div id="customCategorySection" class="mb-4 hidden space-y-3">
                    <div>
                        <label for="customCategoryGroup" class="block text-sm font-medium text-gray-700 mb-1">
                            Category Group <span class="text-red-500">*</span>
                        </label>
                        <select id="customCategoryGroup" name="custom_category_group"
                                class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm">
                            {% for group in category_group_order %}
                            <option value="{{ group }}"{% if group == 'Repairs & Maintenance' %} selected{% endif %}>{{ group }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="customCategoryName" class="block text-sm font-medium text-gray-700 mb-1">
                            New Category Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="customCategoryName" name="custom_category_name"
                               class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm"
                               placeholder="e.g., Security Services">
                        <p id="customCategoryError" class="mt-1 text-xs text-red-600 hidden">
                            This category already exists. Please select it from the dropdown.
                        </p>
                    </div>

                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="customCategoryDeductible" checked
                                   class="rounded border-slate text-accent shadow-sm focus:border-accent focus:ring-accent">
                            <span class="ml-2 text-sm text-gray-600">This is a deductible rental expense</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="txnVendorName" class="block text-sm font-medium text-gray-700 mb-1">
                        Vendor/Payee Name
                    </label>
                    <input type="text" id="txnVendorName" name="vendor_name"
                           class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm"
                           placeholder="e.g., ABC Plumbing, Auckland Council">
                </div>

                <div class="mb-4">
                    <label for="txnNotes" class="block text-sm font-medium text-gray-700 mb-1">
                        Additional Notes
                    </label>
                    <textarea id="txnNotes" name="notes" rows="2"
                              class="w-full rounded-md border-slate shadow-sm focus:border-accent focus:ring-accent sm:text-sm"
                              placeholder="Any additional context about this transaction..."></textarea>
                </div>

                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-800">
                        <strong>Note:</strong> This feedback helps improve future transaction analysis.
                        Legitimate rental expenses with proper categorization will not be flagged in future reviews.
                    </p>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeTransactionModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" id="txnSubmitBtn"
                            class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-accent hover:bg-accent-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="txnSubmitText">Submit Feedback</span>
                        <span id="txnSubmitLoading" class="hidden">Submitting...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transaction Processing Progress Modal -->
<div x-show="processing" x-cloak
     class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-primary px-6 py-4">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <svg class="animate-spin mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing Transactions
            </h3>
        </div>

        <!-- Progress Content -->
        <div class="px-6 py-4">
            <!-- Overall Progress Bar -->
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Overall Progress</span>
                    <span x-text="Math.round(overallProgress) + '%'"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-accent h-2 rounded-full transition-all duration-500"
                         :style="'width: ' + overallProgress + '%'"></div>
                </div>
            </div>

            <!-- Current Stage -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-900" x-text="currentStage"></p>
                <p class="text-xs text-gray-500 mt-1" x-text="currentStageDetail"></p>
            </div>

            <!-- Document List -->
            <div class="space-y-2 max-h-48 overflow-y-auto">
                <template x-for="(doc, index) in documentStatuses" :key="index">
                    <div class="flex items-center justify-between p-2 rounded text-sm"
                         :class="{
                             'bg-green-50': doc.status === 'complete',
                             'bg-blue-50': doc.status === 'processing',
                             'bg-gray-50': doc.status === 'pending'
                         }">
                        <div class="flex items-center min-w-0 flex-1">
                            <!-- Status Icon -->
                            <span class="flex-shrink-0 mr-2">
                                <template x-if="doc.status === 'complete'">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </template>
                                <template x-if="doc.status === 'processing'">
                                    <svg class="w-4 h-4 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </template>
                                <template x-if="doc.status === 'pending'">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </template>
                            </span>
                            <!-- Document name -->
                            <span class="truncate text-gray-700" x-text="doc.name"></span>
                        </div>
                        <!-- Status Text -->
                        <span class="flex-shrink-0 ml-2 text-xs"
                              :class="{
                                  'text-green-600': doc.status === 'complete',
                                  'text-blue-600': doc.status === 'processing',
                                  'text-gray-400': doc.status === 'pending'
                              }"
                              x-text="doc.status === 'complete' ? 'Done' : doc.status === 'processing' ? 'Processing...' : 'Pending'">
                        </span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 flex items-center justify-between">
            <p class="text-xs text-gray-500">
                Please don't close this page while transactions are being processed.
            </p>
            <button type="button" @click="cancelProcessing()"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="toastMessage">Feedback submitted successfully!</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Transaction Processor Alpine.js Component
function transactionProcessor() {
    return {
        processing: false,
        processed: false,
        processingResult: null,
        overallProgress: 0,
        currentStage: 'Initializing...',
        currentStageDetail: 'Preparing to process transactions',
        estimatedTimeRemaining: 0,
        progressInterval: null,
        documentStatuses: [],
        taxReturnId: '{{ tax_return.id }}',
        abortController: null,
        eventSource: null,
        cancelled: false,

        cancelProcessing() {
            this.cancelled = true;
            this.processing = false;
            this.currentStage = 'Cancelled';
            this.currentStageDetail = 'Processing was cancelled by user';

            // Close SSE connection if open
            if (this.eventSource) {
                this.eventSource.close();
            }

            // Also abort any fetch requests
            if (this.abortController) {
                this.abortController.abort();
            }

            showToast('Processing cancelled', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        },

        // Get list of financial documents to process (all transaction-bearing document types)
        getFinancialDocuments() {
            const docs = [];
            {% for doc in documents %}
            {% if doc.document_type in ['bank_statement', 'loan_statement', 'property_manager_statement', 'settlement_statement', 'depreciation_schedule', 'body_corporate', 'rates', 'landlord_insurance', 'maintenance_invoice'] %}
            docs.push({
                id: '{{ doc.id }}',
                name: '{{ doc.original_filename }}',
                type: '{{ doc.document_type }}',
                status: 'pending',
                count: 0
            });
            {% endif %}
            {% endfor %}
            return docs;
        },

        async startProcessing(taxReturnId) {
            this.processing = true;
            this.processed = false;
            this.processingResult = null;
            this.overallProgress = 0;
            this.taxReturnId = taxReturnId;
            this.cancelled = false;

            // Initialize document list
            this.documentStatuses = this.getFinancialDocuments();

            // If no financial documents, show message and return
            if (this.documentStatuses.length === 0) {
                this.documentStatuses = [{ name: 'All documents', status: 'pending', count: 0 }];
            }

            // Stage name mapping for display - must match backend stages
            const stageNames = {
                'initializing': 'Initializing',
                'loading_documents': 'Loading Documents',
                'reading_transactions': 'Reading Transactions',
                'applying_feedback': 'Applying Corrections',
                'querying_rag': 'Matching Patterns',
                'categorizing': 'Categorizing Transactions',
                'applying_tax_rules': 'Applying Tax Rules',
                'generating_summaries': 'Generating Summaries',
                'finalizing': 'Finalizing',
                'complete': 'Complete!',
                'error': 'Error'
            };

            try {
                // Connect to SSE stream for real-time progress
                const eventSource = new EventSource(`/api/transactions/process/${taxReturnId}/stream`);

                // Store eventSource for cancellation
                this.eventSource = eventSource;

                eventSource.onmessage = (event) => {
                    if (this.cancelled) {
                        eventSource.close();
                        return;
                    }

                    try {
                        const data = JSON.parse(event.data);

                        // Update progress
                        this.overallProgress = data.progress;
                        this.currentStage = stageNames[data.stage] || data.stage;
                        this.currentStageDetail = data.detail || data.message;

                        // Update document statuses based on progress
                        if (this.overallProgress >= 10 && this.documentStatuses.length > 0) {
                            const progressPerDoc = 70 / this.documentStatuses.length;
                            const docProgress = (this.overallProgress - 10) / progressPerDoc;

                            for (let i = 0; i < this.documentStatuses.length; i++) {
                                if (i < Math.floor(docProgress)) {
                                    this.documentStatuses[i].status = 'complete';
                                } else if (i === Math.floor(docProgress)) {
                                    this.documentStatuses[i].status = 'processing';
                                }
                            }
                        }

                        // Handle completion
                        if (data.stage === 'complete') {
                            eventSource.close();
                            this.overallProgress = 100;
                            this.processed = true;

                            // Mark all documents as complete
                            this.documentStatuses.forEach(doc => {
                                doc.status = 'complete';
                            });

                            showToast(data.message, 'success');

                            // Redirect after delay
                            setTimeout(() => {
                                this.processing = false;
                                window.location.href = `/workings/${taxReturnId}`;
                            }, 1500);
                        }

                        // Handle error
                        if (data.stage === 'error') {
                            eventSource.close();
                            this.processing = false;
                            this.currentStage = 'Error';
                            this.currentStageDetail = data.detail || data.message;
                            showToast(`Error: ${data.detail || data.message}`, 'error');
                        }

                    } catch (parseError) {
                        console.error('Error parsing SSE data:', parseError);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('SSE error:', error);
                    eventSource.close();

                    if (!this.cancelled && !this.processed) {
                        // Fallback to regular POST if SSE fails
                        console.log('SSE failed, falling back to regular POST');
                        this.fallbackProcessing(taxReturnId);
                    }
                };

            } catch (error) {
                console.error('Error starting SSE:', error);
                // Fallback to regular POST
                this.fallbackProcessing(taxReturnId);
            }
        },

        // Fallback processing without SSE (used if SSE fails)
        async fallbackProcessing(taxReturnId) {
            try {
                const response = await fetch(`/api/transactions/process/${taxReturnId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    this.overallProgress = 100;
                    this.currentStage = 'Complete!';
                    this.currentStageDetail = `Processed ${result.total_transactions} transactions`;
                    this.processed = true;

                    this.documentStatuses.forEach(doc => {
                        doc.status = 'complete';
                    });

                    showToast(
                        `Processed ${result.total_transactions} transactions.`,
                        'success'
                    );

                    setTimeout(() => {
                        this.processing = false;
                        if (result.total_transactions > 0) {
                            window.location.href = `/workings/${taxReturnId}`;
                        }
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Processing failed');
                }
            } catch (error) {
                console.error('Error in fallback processing:', error);
                this.processing = false;
                this.currentStage = 'Error';
                this.currentStageDetail = error.message;
                showToast(`Error: ${error.message}`, 'error');
            }
        }
    };
}

// Currency formatting helper
function formatCurrency(amount) {
    return '$' + parseFloat(amount).toLocaleString('en-NZ', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

async function processTransactions(documentId, taxReturnId) {
    const button = document.getElementById(`process-btn-${documentId}`);
    const originalText = button.textContent;

    try {
        // Update button state
        button.textContent = 'Processing...';
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');

        // Call the processing API
        const params = new URLSearchParams({
            document_id: documentId,
            tax_return_id: taxReturnId,
            force_reprocess: false
        });

        const response = await fetch(`/api/transactions/process/document?${params}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            // Show success message
            showToast(`Successfully processed ${result.transactions.length} transactions`, 'success');

            // Update button to show completion
            button.textContent = 'Processed';
            button.classList.remove('text-blue-600', 'hover:text-blue-800');
            button.classList.add('text-green-600');

            // Add link to view transactions
            setTimeout(() => {
                window.location.href = `/workings/${taxReturnId}`;
            }, 2000);
        } else {
            throw new Error(result.message || 'Processing failed');
        }
    } catch (error) {
        console.error('Error processing transactions:', error);
        showToast(`Error: ${error.message}`, 'error');

        // Restore button
        button.textContent = originalText;
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

async function processAllTransactions(taxReturnId) {
    const button = event.target;
    const originalHtml = button.innerHTML;

    try {
        // Update button state
        button.innerHTML = '<span class="animate-pulse">Processing all documents...</span>';
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');

        // Call the API to process all transactions
        const response = await fetch(`/api/transactions/process/${taxReturnId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            // Show success message
            showToast(
                `Processed ${result.total_transactions} transactions from ${result.documents_processed.length} documents. ` +
                `${result.transactions_categorized} categorized, ${result.transactions_needing_review} need review.`,
                'success'
            );

            // Update button to show completion
            button.innerHTML = '<span>All Transactions Processed</span>';
            button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            button.classList.add('bg-green-600');

            // Optionally redirect to transactions view after a delay
            if (result.total_transactions > 0) {
                setTimeout(() => {
                    window.location.href = `/workings/${taxReturnId}`;
                }, 3000);
            }
        } else {
            throw new Error(result.message || 'Processing failed');
        }
    } catch (error) {
        console.error('Error processing all transactions:', error);
        showToast(`Error: ${error.message}`, 'error');

        // Restore button
        button.innerHTML = originalHtml;
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastDiv = toast.querySelector('div');

    toastMessage.textContent = message;

    // Update toast styling based on type
    if (type === 'error') {
        toastDiv.classList.remove('bg-green-500');
        toastDiv.classList.add('bg-red-500');
    } else {
        toastDiv.classList.remove('bg-red-500');
        toastDiv.classList.add('bg-green-500');
    }

    toast.classList.remove('hidden');

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 5000);
}

// === Blocking Issue Resolution Functions ===

function getIssueTextFromButton(button) {
    // Find the parent li element with the data-issue attribute
    const issueEl = button.closest('[data-issue]');
    return issueEl ? issueEl.getAttribute('data-issue') : null;
}

function handleBlockingIssueOk(button) {
    const issueText = getIssueTextFromButton(button);
    if (issueText) {
        resolveBlockingIssue(issueText, 'ok');
    } else {
        console.error('Could not find issue text');
        showToast('Error: Could not find issue text', 'error');
    }
}

function handleBlockingIssueFeedback(button) {
    const issueText = getIssueTextFromButton(button);
    if (issueText) {
        showBlockingIssueFeedback(issueText);
    } else {
        console.error('Could not find issue text');
        showToast('Error: Could not find issue text', 'error');
    }
}

async function resolveBlockingIssue(issueText, resolutionType, feedbackContent = null) {
    const taxReturnId = '{{ tax_return.id }}';

    try {
        const payload = {
            tax_return_id: taxReturnId,
            issue_text: issueText,
            resolution_type: resolutionType
        };

        if (feedbackContent) {
            payload.feedback_content = feedbackContent;
        }

        const response = await fetch('/api/blocking-issues/resolve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok && result.resolved) {
            showToast(result.message, 'success');

            // Update the UI to show the issue as resolved
            updateBlockingIssueUI(issueText);

            // If status was updated, update the badge and refresh the page
            if (result.status_updated && result.new_status) {
                updateStatusBadge(result.new_status);
                showToast(`All blocking issues resolved! Status updated to ${result.new_status.toUpperCase()}.`);
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        } else {
            throw new Error(result.detail || 'Failed to resolve blocking issue');
        }
    } catch (error) {
        console.error('Error resolving blocking issue:', error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

function updateBlockingIssueUI(issueText) {
    // Find the issue element by its data attribute
    const issueElements = document.querySelectorAll('[data-issue]');
    for (const el of issueElements) {
        if (el.getAttribute('data-issue') === issueText) {
            // Update styling to show resolved
            el.classList.remove('bg-white', 'border-red-100');
            el.classList.add('bg-green-50', 'border', 'border-green-200');

            // Update the icon and text
            const iconContainer = el.querySelector('.flex-grow');
            if (iconContainer) {
                iconContainer.innerHTML = `
                    <svg class="w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium text-green-800 line-through">${issueText}</span>
                `;
            }

            // Remove the action buttons and add "Resolved" label
            const buttonsContainer = el.querySelector('.flex-shrink-0');
            if (buttonsContainer) {
                buttonsContainer.innerHTML = '<span class="text-xs text-green-600 ml-4">Resolved</span>';
            }

            break;
        }
    }

    // Update the header counts
    updateBlockingIssuesCounts();
}

function updateBlockingIssuesCounts() {
    const section = document.getElementById('blockingIssuesSection');
    if (!section) return;

    const allIssues = section.querySelectorAll('[data-issue]');
    const resolvedIssues = section.querySelectorAll('.bg-green-50');
    const unresolvedCount = allIssues.length - resolvedIssues.length;

    const countsContainer = section.querySelector('.flex.items-center.gap-2');
    if (countsContainer) {
        countsContainer.innerHTML = `
            <span class="text-sm text-red-700">${unresolvedCount} unresolved</span>
            ${resolvedIssues.length > 0 ? `<span class="text-sm text-green-700">${resolvedIssues.length} resolved</span>` : ''}
        `;
    }
}

function showBlockingIssueFeedback(issueText) {
    document.getElementById('blockingIssueText').value = issueText;
    document.getElementById('blockingIssueDisplay').textContent = issueText;
    document.getElementById('blockingIssueFeedbackContent').value = '';
    document.getElementById('blockingIssueFeedbackModal').classList.remove('hidden');
}

function closeBlockingIssueFeedbackModal() {
    document.getElementById('blockingIssueFeedbackModal').classList.add('hidden');
    document.getElementById('blockingIssueFeedbackForm').reset();
}

async function submitBlockingIssueFeedback(event) {
    event.preventDefault();

    const issueText = document.getElementById('blockingIssueText').value;
    const feedbackContent = document.getElementById('blockingIssueFeedbackContent').value;

    if (!feedbackContent.trim()) {
        showToast('Please provide feedback explaining why this is not a blocking issue', 'error');
        return;
    }

    const submitBtn = document.getElementById('blockingIssueFeedbackSubmit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    try {
        await resolveBlockingIssue(issueText, 'feedback', feedbackContent);
        closeBlockingIssueFeedbackModal();
    } catch (error) {
        console.error('Error submitting feedback:', error);
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}

// Close modal on background click
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('blockingIssueFeedbackModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeBlockingIssueFeedbackModal();
            }
        });
    }
});

function reportDocumentIssue(docId, filename, currentType) {
    document.getElementById('feedbackDocumentId').value = docId;
    document.getElementById('feedbackFilename').textContent = filename;
    document.getElementById('feedbackCurrentType').textContent = currentType || 'Unknown';
    document.getElementById('feedbackModal').classList.remove('hidden');
}

// Toggle document details panel
function toggleDocumentDetails(docId) {
    const panel = document.getElementById('details-panel-' + docId);
    const icon = document.getElementById('details-icon-' + docId);
    const text = document.getElementById('details-text-' + docId);

    if (panel) {
        const isHidden = panel.style.display === 'none' || panel.classList.contains('hidden');

        if (isHidden) {
            // Show panel
            panel.style.display = 'block';
            panel.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
            text.textContent = 'Hide Details';
        } else {
            // Hide panel
            panel.style.display = 'none';
            panel.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
            text.textContent = 'Show Details';
        }
    }
}

function closeModal() {
    document.getElementById('feedbackModal').classList.add('hidden');
    document.getElementById('quickFeedbackForm').reset();
}

async function submitQuickFeedback(event) {
    event.preventDefault();

    const form = event.target;
    const filename = document.getElementById('feedbackFilename').textContent;
    const currentType = document.getElementById('feedbackCurrentType').textContent;
    const correctType = document.getElementById('correctType').value;
    const notes = document.getElementById('feedbackNotes').value;

    // Build the learning content
    const content = `Document "${filename}" was incorrectly classified as "${currentType}" but should be "${correctType}". ${notes ? 'Additional context: ' + notes : ''} When classifying similar documents, look for characteristics that distinguish ${correctType} from ${currentType}.`;

    // Build scenario name
    const scenario = `${currentType}_misclassified_as_${correctType}`.toLowerCase().replace(/[^a-z0-9_]/g, '_');

    try {
        const response = await fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                scenario: scenario,
                category: 'document_classification',
                tax_return_id: document.getElementById('feedbackTaxReturnId').value,
                document_id: document.getElementById('feedbackDocumentId').value
            })
        });

        if (response.ok) {
            closeModal();
            showToast('Correction submitted! This will improve future classifications.');
        } else {
            const error = await response.json();
            alert('Failed to submit feedback: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error submitting feedback: ' + error.message);
    }
}

function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    toast.classList.remove('hidden');

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 4000);
}

// Transaction feedback modal functions
let currentFeedbackButton = null;

function openTransactionFeedback(btn) {
    const transaction = btn.getAttribute('data-transaction');
    const amount = btn.getAttribute('data-amount');
    const doc = btn.getAttribute('data-document');

    currentFeedbackButton = btn;  // Store reference to the button

    document.getElementById('txnDescription').textContent = transaction;
    document.getElementById('txnAmount').textContent = formatCurrency(amount);
    document.getElementById('txnDocument').textContent = doc;
    document.getElementById('transactionModal').classList.remove('hidden');
}

// Get all existing category values and text for duplicate checking
function getExistingCategories() {
    const select = document.getElementById('txnExpenseCategory');
    const categories = [];
    for (let i = 0; i < select.options.length; i++) {
        const opt = select.options[i];
        if (opt.value && opt.value !== '__create_new__' && opt.value !== '') {
            categories.push({
                value: opt.value.toLowerCase(),
                text: opt.text.toLowerCase()
            });
        }
    }
    return categories;
}

// Toggle custom category input
function toggleCustomCategory(select) {
    const customSection = document.getElementById('customCategorySection');
    const customInput = document.getElementById('customCategoryName');

    if (select.value === '__create_new__') {
        customSection.classList.remove('hidden');
        customInput.required = true;
        customInput.focus();
    } else {
        customSection.classList.add('hidden');
        customInput.required = false;
        customInput.value = '';
        document.getElementById('customCategoryError').classList.add('hidden');
    }
}

// Check for duplicate category
function checkDuplicateCategory(inputValue) {
    const normalized = inputValue.toLowerCase().trim();
    const normalizedValue = normalized.replace(/[^a-z0-9]/g, '_');
    const existingCategories = getExistingCategories();

    for (const cat of existingCategories) {
        // Check if text matches
        if (cat.text === normalized) {
            return { isDuplicate: true, matchedText: cat.text };
        }
        // Check if value would match (normalized)
        if (cat.value === normalizedValue) {
            return { isDuplicate: true, matchedText: cat.text };
        }
        // Check for partial matches (e.g., "plumbing" vs "Plumbing Services")
        if (cat.text.includes(normalized) || normalized.includes(cat.text)) {
            return { isDuplicate: true, matchedText: cat.text };
        }
    }
    return { isDuplicate: false };
}

// === Add Documents Functions ===
let addDocsFiles = [];

function toggleAddDocuments() {
    const section = document.getElementById('addDocumentsSection');
    section.classList.toggle('hidden');
    if (section.classList.contains('hidden')) {
        // Reset when hiding
        addDocsFiles = [];
        updateAddDocsFileList();
        document.getElementById('additionalFiles').value = '';
    }
}

function handleAddDocsFiles(files) {
    addDocsFiles = [...addDocsFiles, ...Array.from(files)];
    updateAddDocsFileList();
}

function handleAddDocsDrop(event) {
    const files = event.dataTransfer.files;
    handleAddDocsFiles(files);
    // Update the file input
    const dataTransfer = new DataTransfer();
    addDocsFiles.forEach(file => dataTransfer.items.add(file));
    document.getElementById('additionalFiles').files = dataTransfer.files;
}

function removeAddDocsFile(index) {
    addDocsFiles.splice(index, 1);
    updateAddDocsFileList();
    // Update the file input
    const dataTransfer = new DataTransfer();
    addDocsFiles.forEach(file => dataTransfer.items.add(file));
    document.getElementById('additionalFiles').files = dataTransfer.files;
}

function updateAddDocsFileList() {
    const listContainer = document.getElementById('addDocsFileList');
    const listItems = document.getElementById('addDocsFileListItems');
    const countSpan = document.getElementById('addDocsFileCount');

    if (addDocsFiles.length === 0) {
        listContainer.classList.add('hidden');
        return;
    }

    listContainer.classList.remove('hidden');
    countSpan.textContent = addDocsFiles.length;

    listItems.innerHTML = addDocsFiles.map((file, index) => `
        <li class="pl-3 pr-4 py-3 flex items-center justify-between text-sm">
            <div class="flex-1 flex items-center">
                <span class="flex-1 truncate">${file.name}</span>
                <span class="ml-2 text-gray-500">${formatFileSize(file.size)}</span>
            </div>
            <button type="button" onclick="removeAddDocsFile(${index})"
                    class="ml-4 text-red-600 hover:text-red-800">Remove</button>
        </li>
    `).join('');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Handle add documents form submission
document.addEventListener('DOMContentLoaded', function() {
    const addDocsForm = document.getElementById('addDocumentsForm');
    if (addDocsForm) {
        addDocsForm.addEventListener('submit', function() {
            const submitBtn = document.getElementById('addDocsSubmitBtn');
            const submitText = document.getElementById('addDocsSubmitText');
            const submitLoading = document.getElementById('addDocsSubmitLoading');

            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
        });
    }
});

// Load custom categories from API on page load
async function loadCustomCategories() {
    try {
        const response = await fetch('/api/categories');
        if (response.ok) {
            const data = await response.json();
            if (data.categories && data.categories.length > 0) {
                data.categories.forEach(cat => {
                    addCustomCategoryToDropdown(cat.name, cat.value, cat.is_deductible, cat.group);
                });
                console.log(`Loaded ${data.categories.length} custom categories`);
            }
        }
    } catch (error) {
        console.error('Error loading custom categories:', error);
    }
}

// Save custom category to API
async function saveCustomCategory(name, value, group, isDeductible) {
    try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('value', value);
        formData.append('group', group);
        formData.append('is_deductible', isDeductible);

        const response = await fetch('/api/categories', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            console.log('Custom category saved successfully');
            return true;
        } else {
            console.error('Failed to save custom category');
            return false;
        }
    } catch (error) {
        console.error('Error saving custom category:', error);
        return false;
    }
}

// Validate custom category on input
document.addEventListener('DOMContentLoaded', function() {
    // Load custom categories
    loadCustomCategories();

    const customInput = document.getElementById('customCategoryName');
    if (customInput) {
        customInput.addEventListener('input', function() {
            const errorEl = document.getElementById('customCategoryError');
            const result = checkDuplicateCategory(this.value);

            if (result.isDuplicate && this.value.trim().length > 0) {
                errorEl.textContent = `Similar category "${result.matchedText}" already exists. Please select it from the dropdown.`;
                errorEl.classList.remove('hidden');
                this.classList.add('border-red-500');
            } else {
                errorEl.classList.add('hidden');
                this.classList.remove('border-red-500');
            }
        });
    }
});

// Add custom category to dropdown for future use
function addCustomCategoryToDropdown(displayText, value, isDeductible, groupName) {
    const select = document.getElementById('txnExpenseCategory');

    // Find the target optgroup by label
    let targetGroup = select.querySelector(`optgroup[label="${groupName}"]`);

    // If not found, create a new group
    if (!targetGroup) {
        targetGroup = document.createElement('optgroup');
        targetGroup.label = groupName;

        // Insert before the "Create New" optgroup
        const createNewGroup = select.querySelector('optgroup[label="─────────────────"]');
        if (createNewGroup) {
            select.insertBefore(targetGroup, createNewGroup);
        } else {
            select.appendChild(targetGroup);
        }
    }

    // Create the new option
    const newOption = document.createElement('option');
    newOption.value = value;
    const skipNonDeductible = ['Income', 'Excluded'].includes(groupName);
    newOption.textContent = displayText + (!isDeductible && !skipNonDeductible ? ' (not deductible)' : '');

    // Add to the target group
    targetGroup.appendChild(newOption);
}

function closeTransactionModal() {
    document.getElementById('transactionModal').classList.add('hidden');
    document.getElementById('transactionFeedbackForm').reset();
    document.getElementById('customCategorySection').classList.add('hidden');
    document.getElementById('customCategoryError').classList.add('hidden');
    document.getElementById('customCategoryName').classList.remove('border-red-500');
    resetSubmitButton();
    currentFeedbackButton = null;
}

function resetSubmitButton() {
    const submitBtn = document.getElementById('txnSubmitBtn');
    submitBtn.disabled = false;
    document.getElementById('txnSubmitText').classList.remove('hidden');
    document.getElementById('txnSubmitLoading').classList.add('hidden');
}

async function submitTransactionFeedback(event) {
    event.preventDefault();

    // Prevent double submission
    const submitBtn = document.getElementById('txnSubmitBtn');
    if (submitBtn.disabled) return;

    submitBtn.disabled = true;
    document.getElementById('txnSubmitText').classList.add('hidden');
    document.getElementById('txnSubmitLoading').classList.remove('hidden');

    const transaction = document.getElementById('txnDescription').textContent;
    const amount = document.getElementById('txnAmount').textContent;
    const docName = document.getElementById('txnDocument').textContent;
    let expenseCategory = document.getElementById('txnExpenseCategory').value;
    const vendorName = document.getElementById('txnVendorName').value;
    const notes = document.getElementById('txnNotes').value;

    // Track if this is a custom category before modifying expenseCategory
    const isCustomCategory = expenseCategory === '__create_new__';

    // Handle custom category
    let categoryText;
    let isDeductible;
    let selectedGroup = null;

    if (isCustomCategory) {
        const customName = document.getElementById('customCategoryName').value.trim();

        // Validate custom category isn't duplicate
        const duplicateCheck = checkDuplicateCategory(customName);
        if (duplicateCheck.isDuplicate) {
            document.getElementById('customCategoryError').textContent =
                `Similar category "${duplicateCheck.matchedText}" already exists. Please select it from the dropdown.`;
            document.getElementById('customCategoryError').classList.remove('hidden');
            document.getElementById('customCategoryName').classList.add('border-red-500');
            resetSubmitButton();
            return;
        }

        if (!customName) {
            alert('Please enter a category name');
            resetSubmitButton();
            return;
        }

        categoryText = customName;
        expenseCategory = customName.toLowerCase().replace(/[^a-z0-9]/g, '_');
        isDeductible = document.getElementById('customCategoryDeductible').checked;
        selectedGroup = document.getElementById('customCategoryGroup').value;
    } else {
        // Get the display text for the category
        const categorySelect = document.getElementById('txnExpenseCategory');
        categoryText = categorySelect.options[categorySelect.selectedIndex].text;

        isDeductible = !expenseCategory.includes('not_deductible') &&
                       expenseCategory !== 'personal_expense' &&
                       expenseCategory !== 'capital_expense' &&
                       expenseCategory !== 'loan_principal';
    }

    // Build learning content based on expense category
    let content;

    if (isDeductible) {
        content = `Transaction "${transaction}" (${amount}) is a LEGITIMATE rental expense. ` +
                  `Category: ${categoryText}. ` +
                  (vendorName ? `Vendor: ${vendorName}. ` : '') +
                  `Do NOT flag similar transactions to this vendor/type in future analyses. ` +
                  (notes ? `Notes: ${notes}` : '');
    } else {
        content = `Transaction "${transaction}" (${amount}) is NOT a deductible rental expense. ` +
                  `Category: ${categoryText}. ` +
                  (vendorName ? `Vendor: ${vendorName}. ` : '') +
                  `Continue flagging similar transactions as they are not legitimate rental expenses. ` +
                  (notes ? `Notes: ${notes}` : '');
    }

    const scenario = isDeductible ? 'legitimate_rental_expense' : 'non_deductible_expense';

    try {
        // Use the transactions feedback endpoint for proper reconciliation tracking
        const response = await fetch('/api/transactions/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transaction_description: transaction,
                amount: parseFloat(amount.replace('$', '')),
                document_name: docName,
                resolution: isDeductible ? 'legitimate' : 'personal',
                vendor_name: vendorName || null,
                expense_category: categoryText,
                notes: notes || null,
                tax_return_id: '{{ tax_return.id }}'
            })
        });

        if (response.ok) {
            const result = await response.json();

            // If this was a custom category, save it to API and add to dropdown
            if (isCustomCategory && selectedGroup) {
                // Save to API for persistence across page reloads
                await saveCustomCategory(categoryText, expenseCategory, selectedGroup, isDeductible);
                // Add to current dropdown
                addCustomCategoryToDropdown(categoryText, expenseCategory, isDeductible, selectedGroup);
            }

            // Mark the row as reconciled BEFORE closing modal
            // (closeTransactionModal sets currentFeedbackButton to null)
            if (currentFeedbackButton) {
                markRowAsReconciled(currentFeedbackButton, 'categorize');
            }

            closeTransactionModal();

            // Check if status was updated to complete
            if (result.status_updated && result.new_status === 'complete') {
                // Update the status badge on the page
                updateStatusBadge('complete');
                showToast('All transactions reconciled! Status updated to COMPLETE.');
            } else if (isDeductible) {
                showToast('Categorized as ' + categoryText + '. AI will learn from this.');
            } else {
                showToast('Categorized as ' + categoryText + '. Similar transactions will be flagged.');
            }
        } else {
            const error = await response.json();
            alert('Failed to submit feedback: ' + (error.detail || 'Unknown error'));
            resetSubmitButton();
        }
    } catch (error) {
        alert('Error submitting feedback: ' + error.message);
        resetSubmitButton();
    }
}

// Update status badge dynamically
function updateStatusBadge(newStatus) {
    const statusBadges = document.querySelectorAll('.rounded-full.font-medium');
    statusBadges.forEach(badge => {
        if (badge.textContent.includes('COMPLETE') || badge.textContent.includes('BLOCKED') ||
            badge.textContent.includes('INCOMPLETE') || badge.textContent.includes('PENDING')) {
            if (newStatus === 'complete') {
                badge.className = 'px-4 py-2 bg-green-100 text-green-800 rounded-full font-medium';
                badge.textContent = 'COMPLETE';
            }
        }
    });
}

// Track reconciled count
let reconciledTransactions = new Set();

// Update the reconciled counter in header
function updateReconciledCounter() {
    const counterEl = document.getElementById('reconciledCount');
    if (counterEl) {
        counterEl.textContent = reconciledTransactions.size;
    }
}

// Mark a transaction row as reconciled
function markRowAsReconciled(btn, method = 'ok') {
    const row = btn.closest('.transaction-row');
    if (row) {
        const txnKey = row.getAttribute('data-txn-key');
        reconciledTransactions.add(txnKey);
        updateReconciledCounter();

        // Update row appearance
        row.classList.add('bg-green-50');
        row.classList.remove('hover:bg-gray-50');

        // Replace action buttons with reconciled indicator
        const actionBtns = row.querySelector('.action-buttons');
        if (actionBtns) {
            const label = method === 'categorize' ? 'Categorized' : 'Reviewed';
            actionBtns.innerHTML = `
                <span class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-green-700 bg-green-100">
                    <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    ${label}
                </span>
            `;
        }
    }
}

// Quick reconcile without AI learning (for one-off transactions)
async function quickReconcile(btn) {
    const transaction = btn.getAttribute('data-transaction');
    const amount = btn.getAttribute('data-amount');
    const docName = btn.getAttribute('data-document');

    // Disable buttons to prevent double-click
    const row = btn.closest('.transaction-row');
    const buttons = row.querySelectorAll('button');
    buttons.forEach(b => b.disabled = true);
    btn.innerHTML = '<svg class="animate-spin w-3.5 h-3.5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    try {
        const response = await fetch('/api/transactions/reconcile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                transaction_description: transaction,
                amount: parseFloat(amount),
                document_name: docName,
                tax_return_id: '{{ tax_return.id }}'
            })
        });

        if (response.ok) {
            const result = await response.json();

            // Mark row as reconciled
            markRowAsReconciled(btn, 'ok');

            // Check if status was updated to complete
            if (result.status_updated && result.new_status === 'complete') {
                updateStatusBadge('complete');
                showToast('All transactions reconciled! Status updated to COMPLETE.');
            } else {
                showToast('Transaction marked as reviewed.');
            }
        } else {
            const error = await response.json();
            alert('Failed to reconcile: ' + (error.detail || 'Unknown error'));
            buttons.forEach(b => b.disabled = false);
            btn.innerHTML = '<svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>OK';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        buttons.forEach(b => b.disabled = false);
        btn.innerHTML = '<svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>OK';
    }
}

// Close modal when clicking outside
document.getElementById('feedbackModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('transactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTransactionModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeTransactionModal();
    }
});
</script>
{% endblock %}