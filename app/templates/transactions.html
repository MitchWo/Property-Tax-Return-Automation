{% extends "base.html" %}

{% block title %}Transactions - {{ client.name }} - {{ tax_return.property_address }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6" x-data="transactionManager()">

    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Transaction Review</h2>
                <p class="mt-1 text-sm text-gray-500">
                    {{ client.name }} - {{ tax_return.property_address }}
                </p>
                <p class="text-sm text-gray-500">
                    Tax Year: {{ tax_return.tax_year }} |
                    Type: {{ "New Build" if tax_return.property_type.value == "new_build" else "Existing" }}
                </p>
            </div>
            <div class="flex space-x-3">
                <a href="/result/{{ tax_return.id }}"
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    ‚Üê Back to Review
                </a>
                <button @click="regenerateSummaries()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                    Regenerate Summaries
                </button>
                <button @click="generateWorkbook()"
                        :disabled="generatingWorkbook"
                        class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 disabled:opacity-50">
                    <span x-show="!generatingWorkbook">üìä Generate Workbook</span>
                    <span x-show="generatingWorkbook" x-cloak>Generating...</span>
                </button>
            </div>
        </div>

        <!-- Workbook download link -->
        <div x-show="workbookReady" x-cloak class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
            <div class="flex items-center justify-between">
                <span class="text-green-800">‚úì Workbook generated successfully</span>
                <a :href="workbookUrl"
                   class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700">
                    ‚¨áÔ∏è Download Excel
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white shadow rounded-lg p-4">
            <div class="text-sm font-medium text-gray-500">Total Transactions</div>
            <div class="text-2xl font-bold text-gray-900">{{ total_count }}</div>
        </div>
        <div class="bg-green-50 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-green-700">Total Income</div>
            <div class="text-2xl font-bold text-green-900">${{ "%.2f"|format(total_income) }}</div>
        </div>
        <div class="bg-red-50 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-red-700">Total Expenses</div>
            <div class="text-2xl font-bold text-red-900">${{ "%.2f"|format(total_expenses) }}</div>
        </div>
        <div class="bg-yellow-50 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-yellow-700">Needs Review</div>
            <div class="text-2xl font-bold text-yellow-900">{{ needs_review_count }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex flex-wrap gap-4 items-center">
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
                <select x-model="filters.category" @change="applyFilters()"
                        class="rounded-md border-gray-300 text-sm">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category_code }}">{{ cat.display_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Type</label>
                <select x-model="filters.type" @change="applyFilters()"
                        class="rounded-md border-gray-300 text-sm">
                    <option value="">All Types</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                    <option value="excluded">Excluded</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Status</label>
                <select x-model="filters.needsReview" @change="applyFilters()"
                        class="rounded-md border-gray-300 text-sm">
                    <option value="">All</option>
                    <option value="true">Needs Review</option>
                    <option value="false">Reviewed</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-500 mb-1">Search</label>
                <input type="text" x-model="filters.search" @input.debounce.300ms="applyFilters()"
                       placeholder="Search description..."
                       class="w-full rounded-md border-gray-300 text-sm">
            </div>
            <div class="self-end">
                <button @click="clearFilters()" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div x-show="selectedTransactions.length > 0" x-cloak
         class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center justify-between">
            <span class="text-sm text-blue-700">
                <span x-text="selectedTransactions.length"></span> transactions selected
            </span>
            <div class="flex items-center space-x-3">
                <select x-model="bulkCategory" class="rounded-md border-gray-300 text-sm">
                    <option value="">Select category...</option>
                    {% for cat in categories %}
                    <option value="{{ cat.category_code }}">{{ cat.display_name }}</option>
                    {% endfor %}
                </select>
                <label class="flex items-center text-sm">
                    <input type="checkbox" x-model="applyToSimilar" class="rounded mr-2">
                    Learn pattern
                </label>
                <button @click="bulkUpdate()"
                        :disabled="!bulkCategory"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 disabled:opacity-50">
                    Apply to Selected
                </button>
                <button @click="clearSelection()" class="text-sm text-gray-600 hover:text-gray-900">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left">
                            <input type="checkbox" @change="toggleSelectAll($event)"
                                   class="rounded border-gray-300">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Confidence</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for txn in transactions %}
                    <tr class="hover:bg-gray-50 {% if txn.needs_review %}bg-yellow-50{% endif %}"
                        x-show="isVisible('{{ txn.id }}')"
                        data-id="{{ txn.id }}"
                        data-category="{{ txn.category_code or '' }}"
                        data-type="{{ txn.transaction_type or '' }}"
                        data-needs-review="{{ 'true' if txn.needs_review else 'false' }}"
                        data-description="{{ txn.description|lower }}">
                        <td class="px-3 py-3">
                            <input type="checkbox"
                                   :checked="selectedTransactions.includes('{{ txn.id }}')"
                                   @change="toggleSelect('{{ txn.id }}')"
                                   class="rounded border-gray-300">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ txn.transaction_date.strftime('%d/%m/%Y') }}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900 max-w-md">
                            <div class="truncate" title="{{ txn.description }}">
                                {{ txn.description[:60] }}{% if txn.description|length > 60 %}...{% endif %}
                            </div>
                            {% if txn.other_party %}
                            <div class="text-xs text-gray-500">{{ txn.other_party }}</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-mono
                                   {% if txn.amount > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if txn.amount > 0 %}+{% endif %}${{ "%.2f"|format(txn.amount|abs) }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <select class="text-sm rounded border-gray-300 py-1"
                                    data-txn-id="{{ txn.id }}"
                                    @change="updateCategory('{{ txn.id }}', $event.target.value)">
                                <option value="">-- Select --</option>
                                {% for cat in categories %}
                                <option value="{{ cat.category_code }}"
                                        {% if txn.category_code == cat.category_code %}selected{% endif %}>
                                    {{ cat.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            {% if txn.confidence %}
                            <div class="flex items-center justify-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="h-2 rounded-full
                                                {% if txn.confidence >= 0.9 %}bg-green-500
                                                {% elif txn.confidence >= 0.7 %}bg-yellow-500
                                                {% else %}bg-red-500{% endif %}"
                                         style="width: {{ (txn.confidence * 100)|int }}%"></div>
                                </div>
                                <span class="ml-2 text-xs text-gray-500">{{ (txn.confidence * 100)|int }}%</span>
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            {% if txn.manually_reviewed %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                                ‚úì Reviewed
                            </span>
                            {% elif txn.needs_review %}
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800"
                                  title="{{ txn.review_reason or 'Needs review' }}">
                                ‚ö† Review
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                Auto
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <button @click="showDetails('{{ txn.id }}')"
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                Details
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Category Summaries -->
    {% if summaries %}
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Category Summaries</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">P&L Row</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Count</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Gross Amount</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Deductible</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for summary in summaries %}
                    <tr class="{% if summary.transaction_type == 'income' %}bg-green-50{% elif summary.transaction_type == 'expense' %}bg-red-50{% endif %}">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            {{ category_map.get(summary.category_code).display_name if category_map.get(summary.category_code) else summary.category_code }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-500">
                            {{ category_map.get(summary.category_code).pl_row if category_map.get(summary.category_code) else '-' }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center text-gray-900">
                            {{ summary.transaction_count }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-mono text-gray-900">
                            ${{ "%.2f"|format(summary.gross_amount|abs) }}
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-mono text-gray-900">
                            ${{ "%.2f"|format(summary.deductible_amount|abs) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Transaction Detail Modal -->
    <div x-show="showModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showModal = false"></div>

            <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Transaction Details</h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div x-html="modalContent" class="space-y-4">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function transactionManager() {
    return {
        selectedTransactions: [],
        bulkCategory: '',
        applyToSimilar: true,
        filters: {
            category: '',
            type: '',
            needsReview: '',
            search: ''
        },
        showModal: false,
        modalContent: '',
        taxReturnId: '{{ tax_return.id }}',

        // Workbook generation
        generatingWorkbook: false,
        workbookReady: false,
        workbookUrl: '',

        isVisible(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return true;

            const category = row.dataset.category;
            const type = row.dataset.type;
            const needsReview = row.dataset.needsReview;
            const description = row.dataset.description;

            if (this.filters.category && category !== this.filters.category) return false;
            if (this.filters.type && type !== this.filters.type) return false;
            if (this.filters.needsReview && needsReview !== this.filters.needsReview) return false;
            if (this.filters.search && !description.includes(this.filters.search.toLowerCase())) return false;

            return true;
        },

        applyFilters() {
            // Triggers Alpine reactivity
            this.$nextTick(() => {});
        },

        clearFilters() {
            this.filters = { category: '', type: '', needsReview: '', search: '' };
        },

        toggleSelect(id) {
            const index = this.selectedTransactions.indexOf(id);
            if (index > -1) {
                this.selectedTransactions.splice(index, 1);
            } else {
                this.selectedTransactions.push(id);
            }
        },

        toggleSelectAll(event) {
            if (event.target.checked) {
                document.querySelectorAll('tr[data-id]').forEach(row => {
                    if (this.isVisible(row.dataset.id)) {
                        if (!this.selectedTransactions.includes(row.dataset.id)) {
                            this.selectedTransactions.push(row.dataset.id);
                        }
                    }
                });
            } else {
                this.selectedTransactions = [];
            }
        },

        clearSelection() {
            this.selectedTransactions = [];
            this.bulkCategory = '';
        },

        async updateCategory(txnId, category) {
            if (!category) return;

            try {
                const response = await fetch(`/api/transactions/${txnId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category_code: category })
                });

                if (response.ok) {
                    // Update row styling
                    const row = document.querySelector(`tr[data-id="${txnId}"]`);
                    if (row) {
                        row.dataset.category = category;
                        row.classList.remove('bg-yellow-50');
                    }
                } else {
                    alert('Failed to update category');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating category');
            }
        },

        async bulkUpdate() {
            if (!this.bulkCategory || this.selectedTransactions.length === 0) return;

            try {
                const response = await fetch('/api/transactions/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_ids: this.selectedTransactions,
                        category_code: this.bulkCategory,
                        apply_to_similar: this.applyToSimilar
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Updated ${result.updated_count} transactions`);
                    location.reload();
                } else {
                    alert('Failed to update transactions');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating transactions');
            }
        },

        async regenerateSummaries() {
            try {
                const response = await fetch(`/api/transactions/summaries/${this.taxReturnId}/regenerate`, {
                    method: 'POST'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to regenerate summaries');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error regenerating summaries');
            }
        },

        async generateWorkbook() {
            this.generatingWorkbook = true;
            this.workbookReady = false;

            try {
                const response = await fetch(`/api/transactions/workbook/${this.taxReturnId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    this.workbookUrl = data.download_url;
                    this.workbookReady = true;
                } else {
                    const error = await response.json();
                    alert('Failed to generate workbook: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating workbook');
            } finally {
                this.generatingWorkbook = false;
            }
        },

        async showDetails(txnId) {
            try {
                const response = await fetch(`/api/transactions/${txnId}`);
                if (response.ok) {
                    const txn = await response.json();
                    this.modalContent = `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="font-medium">Date:</span> ${txn.transaction_date}</div>
                            <div><span class="font-medium">Amount:</span> $${Math.abs(txn.amount).toFixed(2)}</div>
                            <div class="col-span-2"><span class="font-medium">Description:</span><br>${txn.description}</div>
                            <div><span class="font-medium">Other Party:</span> ${txn.other_party || '-'}</div>
                            <div><span class="font-medium">Category:</span> ${txn.category_display_name || txn.category_code || '-'}</div>
                            <div><span class="font-medium">P&L Row:</span> ${txn.pl_row || '-'}</div>
                            <div><span class="font-medium">Confidence:</span> ${txn.confidence ? (txn.confidence * 100).toFixed(0) + '%' : '-'}</div>
                            <div><span class="font-medium">Source:</span> ${txn.categorization_source || '-'}</div>
                            <div><span class="font-medium">Deductible:</span> ${txn.is_deductible ? txn.deductible_percentage + '%' : 'No'}</div>
                            ${txn.review_reason ? `<div class="col-span-2"><span class="font-medium">Review Reason:</span><br>${txn.review_reason}</div>` : ''}
                        </div>
                    `;
                    this.showModal = true;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    }
}
</script>
{% endblock %}